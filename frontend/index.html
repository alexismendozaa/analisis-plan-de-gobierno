<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Plan de Gobierno Ecuador 2025-2029</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel para JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Componente de Icono personalizado
        const Icon = ({ name, className = "w-6 h-6" }) => {
            useEffect(() => {
                lucide.createIcons();
            }, []);
            return <i data-lucide={name} className={className}></i>;
        };

        const PlanGobiernoMonitor = () => {
            const [excelData, setExcelData] = useState(null);
            const [analyzing, setAnalyzing] = useState(false);
            const [results, setResults] = useState(null);
            const [error, setError] = useState(null);
            const [selectedRow, setSelectedRow] = useState(null);
            const [backendStatus, setBackendStatus] = useState(null);

            const API_URL = 'http://localhost:5050/api';

            // Verificar estado del backend
            const checkBackend = async () => {
                try {
                    const response = await fetch(`${API_URL}/health`);
                    const data = await response.json();
                    setBackendStatus(data);
                    
                    if (data.status !== 'ok') {
                        setError(`‚ö†Ô∏è Advertencia: ${data.ollama !== 'funcionando' ? 'Ollama no est√° corriendo. ' : ''}${data.excel !== 'encontrado' ? 'Excel no encontrado.' : ''}`);
                    }
                    
                    return data.status === 'ok';
                } catch (err) {
                    setError('‚ùå No se puede conectar al backend. Aseg√∫rate de que el servidor est√© corriendo en http://localhost:5050');
                    setBackendStatus({ status: 'error' });
                    return false;
                }
            };

            // Cargar Excel desde el backend
            const loadExcelFile = async () => {
                try {
                    setError(null);
                    setAnalyzing(true);
                    
                    const backendOk = await checkBackend();
                    if (!backendOk) {
                        setAnalyzing(false);
                        return;
                    }
                    
                    const response = await fetch(`${API_URL}/load-excel`);
                    const data = await response.json();
                    
                    if (data.success) {
                        setExcelData(data.data);
                        setError(null);
                        console.log(`‚úÖ Cargados ${data.total} indicadores del Excel`);
                    } else {
                        setError(data.error);
                    }
                    
                    setAnalyzing(false);
                } catch (err) {
                    setError(`Error al cargar el archivo: ${err.message}`);
                    setAnalyzing(false);
                }
            };

            // Analizar indicadores con el backend
            const analyzeIndicators = async () => {
                if (!excelData) return;
                
                setAnalyzing(true);
                setError(null);
                
                try {
                    console.log('üöÄ Enviando indicadores al backend para an√°lisis...');
                    
                    const response = await fetch(`${API_URL}/analyze`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ indicators: excelData })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        setResults(data.results);
                        setError(null);
                        console.log(`‚úÖ An√°lisis completado: ${data.total_analizados} indicadores`);
                    } else {
                        setError(data.error);
                    }
                    
                    setAnalyzing(false);
                } catch (err) {
                    setError(`Error en el an√°lisis: ${err.message}`);
                    setAnalyzing(false);
                }
            };

            const getStatusColor = (estado) => {
                switch (estado) {
                    case 'eficiente':
                        return 'bg-green-50 border-green-200';
                    case 'moderado':
                        return 'bg-yellow-50 border-yellow-200';
                    case 'deficiente':
                        return 'bg-red-50 border-red-200';
                    default:
                        return 'bg-gray-50 border-gray-200';
                }
            };

            const getStatusBadge = (estado, eficiencia) => {
                const colors = {
                    'eficiente': 'bg-green-200 text-green-800',
                    'moderado': 'bg-yellow-200 text-yellow-800',
                    'deficiente': 'bg-red-200 text-red-800'
                };
                return (
                    <span className={`inline-block px-4 py-2 rounded-full text-sm font-semibold ${colors[estado] || 'bg-gray-200 text-gray-800'}`}>
                        {eficiencia}
                    </span>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-6">
                    <div className="max-w-7xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-800 mb-2">
                                        Monitor del Plan de Gobierno Ecuador 2025-2029
                                    </h1>
                                    <p className="text-gray-600">
                                        An√°lisis automatizado con IA del cumplimiento de metas presidenciales
                                    </p>
                                </div>
                                <Icon name="file-spreadsheet" className="w-12 h-12 text-indigo-600" />
                            </div>

                            {/* Estado del Backend */}
                            {backendStatus && (
                                <div className={`mb-4 p-3 rounded-lg flex items-center gap-2 ${
                                    backendStatus.status === 'ok' ? 'bg-green-50 text-green-700' : 'bg-yellow-50 text-yellow-700'
                                }`}>
                                    <Icon name="server" className="w-5 h-5" />
                                    <span className="text-sm">
                                        Backend: {backendStatus.status} | Ollama: {backendStatus.ollama} | Excel: {backendStatus.excel}
                                    </span>
                                </div>
                            )}
                            
                            <div className="flex gap-4 flex-wrap">
                                <button
                                    onClick={loadExcelFile}
                                    disabled={analyzing}
                                    className="flex items-center gap-2 bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
                                >
                                    <Icon name="file-spreadsheet" className="w-5 h-5" />
                                    Cargar Plan de Gobierno
                                </button>
                                
                                {excelData && (
                                    <button
                                        onClick={analyzeIndicators}
                                        disabled={analyzing}
                                        className="flex items-center gap-2 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
                                    >
                                        <Icon name="search" className="w-5 h-5" />
                                        {analyzing ? 'Analizando con IA...' : `Analizar ${excelData.length} Indicadores`}
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Error Message */}
                        {error && (
                            <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-6 flex items-start gap-3">
                                <Icon name="alert-circle" className="w-6 h-6 text-red-600 flex-shrink-0 mt-0.5" />
                                <div>
                                    <h3 className="font-semibold text-red-800">Error</h3>
                                    <p className="text-red-700">{error}</p>
                                </div>
                            </div>
                        )}

                        {/* Loading State */}
                        {analyzing && (
                            <div className="bg-white rounded-lg shadow-lg p-12 mb-6 text-center">
                                <div className="animate-spin w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto mb-4"></div>
                                <p className="text-gray-600 text-lg">
                                    {excelData ? 'ü§ñ Analizando indicadores con Llama IA...' : 'Cargando datos del Excel...'}
                                </p>
                                <p className="text-gray-500 text-sm mt-2">
                                    {excelData ? 'Buscando datos actualizados en fuentes oficiales' : 'Leyendo archivo plan_gobierno_2025_2029.xlsx'}
                                </p>
                            </div>
                        )}

                        {/* Excel Data Loaded */}
                        {excelData && !results && !analyzing && (
                            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                                <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                    ‚úÖ Excel Cargado: {excelData.length} Indicadores Encontrados
                                </h2>
                                <div className="space-y-2 max-h-96 overflow-y-auto">
                                    {excelData.map((row, idx) => (
                                        <div key={idx} className="bg-gray-50 p-4 rounded border border-gray-200 hover:shadow-md transition">
                                            <p className="font-semibold text-indigo-600">{row.Eje}</p>
                                            <p className="text-gray-700">{row.Indicador}</p>
                                            <p className="text-sm text-gray-600">Meta: {row.Meta}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {/* Results Summary */}
                        {results && !analyzing && (
                            <>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="text-gray-600 text-sm">Eficientes</p>
                                                <p className="text-3xl font-bold text-green-600">
                                                    {results.filter(r => r.estado === 'eficiente').length}
                                                </p>
                                            </div>
                                            <Icon name="trending-up" className="w-12 h-12 text-green-500" />
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="text-gray-600 text-sm">Moderados</p>
                                                <p className="text-3xl font-bold text-yellow-600">
                                                    {results.filter(r => r.estado === 'moderado').length}
                                                </p>
                                            </div>
                                            <Icon name="minus" className="w-12 h-12 text-yellow-500" />
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white rounded-lg shadow p-6">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="text-gray-600 text-sm">Deficientes</p>
                                                <p className="text-3xl font-bold text-red-600">
                                                    {results.filter(r => r.estado === 'deficiente').length}
                                                </p>
                                            </div>
                                            <Icon name="trending-down" className="w-12 h-12 text-red-500" />
                                        </div>
                                    </div>
                                </div>

                                {/* Detailed Results */}
                                <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-6">
                                        An√°lisis Detallado por Indicador
                                    </h2>
                                    
                                    <div className="space-y-4">
                                        {results.map((result, index) => (
                                            <div
                                                key={index}
                                                className={`border-2 rounded-lg p-6 transition cursor-pointer hover:shadow-md ${getStatusColor(result.estado)}`}
                                                onClick={() => setSelectedRow(selectedRow === index ? null : index)}
                                            >
                                                <div className="flex items-start justify-between mb-4">
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-3 mb-2">
                                                            <Icon 
                                                                name={result.estado === 'eficiente' ? 'check-circle' : result.estado === 'moderado' ? 'minus' : 'x-circle'} 
                                                                className={`w-6 h-6 ${result.estado === 'eficiente' ? 'text-green-500' : result.estado === 'moderado' ? 'text-yellow-500' : 'text-red-500'}`}
                                                            />
                                                            <h3 className="text-xl font-bold text-gray-800">
                                                                {result.eje}
                                                            </h3>
                                                        </div>
                                                        <p className="text-gray-700 font-medium mb-1">
                                                            {result.indicador}
                                                        </p>
                                                        <p className="text-gray-600 text-sm">
                                                            Meta: {result.meta}
                                                        </p>
                                                    </div>
                                                    <div className="text-right">
                                                        {getStatusBadge(result.estado, result.eficiencia)}
                                                    </div>
                                                </div>

                                                {selectedRow === index && (
                                                    <div className="mt-4 pt-4 border-t border-gray-300 space-y-3">
                                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                            <div>
                                                                <p className="text-sm text-gray-600">Valor Inicial (Mayo 2025)</p>
                                                                <p className="text-lg font-semibold text-gray-800">{result.valor_inicial}</p>
                                                            </div>
                                                            <div>
                                                                <p className="text-sm text-gray-600">Valor Actual</p>
                                                                <p className="text-lg font-semibold text-gray-800">{result.valor_actual}</p>
                                                            </div>
                                                            <div>
                                                                <p className="text-sm text-gray-600 mb-2">Progreso hacia la meta</p>
                                                                <div className="flex items-center gap-2">
                                                                    <div className="flex-1 bg-gray-200 rounded-full h-3">
                                                                        <div
                                                                            className={`h-3 rounded-full transition-all ${
                                                                                result.progreso >= 30 ? 'bg-green-500' :
                                                                                result.progreso >= 15 ? 'bg-yellow-500' :
                                                                                'bg-red-500'
                                                                            }`}
                                                                            style={{ width: `${Math.min(result.progreso, 100)}%` }}
                                                                        ></div>
                                                                    </div>
                                                                    <span className="text-sm font-semibold min-w-12">{result.progreso}%</span>
                                                                </div>
                                                            </div>
                                                            <div>
                                                                <p className="text-sm text-gray-600">√öltima Actualizaci√≥n</p>
                                                                <p className="text-lg font-semibold text-gray-800">{result.fecha_actualizacion}</p>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="bg-white bg-opacity-50 rounded p-4">
                                                            <p className="text-sm font-semibold text-gray-700 mb-2">üìä An√°lisis de IA:</p>
                                                            <p className="text-gray-700 leading-relaxed">{result.analisis}</p>
                                                        </div>
                                                        
                                                        <div className="text-xs text-gray-500 italic">
                                                            Fuente: {result.fuente}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                {/* General Summary */}
                                <div className="bg-white rounded-lg shadow-lg p-6">
                                    <h2 className="text-2xl font-bold text-gray-800 mb-4">
                                        üìã Resumen General del Plan de Gobierno
                                    </h2>
                                    <div className="space-y-4">
                                        <p className="text-gray-700 leading-relaxed">
                                            <strong>Per√≠odo de an√°lisis:</strong> Mayo 2025 - Noviembre 2025 (6 meses transcurridos)
                                        </p>
                                        <p className="text-gray-700 leading-relaxed">
                                            El an√°lisis automatizado del cumplimiento del Plan de Gobierno 2025-2029 con datos obtenidos de fuentes oficiales muestra:
                                        </p>
                                        <div className="bg-blue-50 border-l-4 border-blue-500 p-4 space-y-2">
                                            <p className="text-gray-700">
                                                <strong>Total de indicadores analizados:</strong> {results.length}
                                            </p>
                                            <p className="text-green-700">
                                                <strong>‚úÖ Con avance eficiente:</strong> {results.filter(r => r.estado === 'eficiente').length} ({Math.round(results.filter(r => r.estado === 'eficiente').length / results.length * 100)}%)
                                            </p>
                                            <p className="text-yellow-700">
                                                <strong>‚ö†Ô∏è Con avance moderado:</strong> {results.filter(r => r.estado === 'moderado').length} ({Math.round(results.filter(r => r.estado === 'moderado').length / results.length * 100)}%)
                                            </p>
                                            <p className="text-red-700">
                                                <strong>‚ùå Con avance deficiente:</strong> {results.filter(r => r.estado === 'deficiente').length} ({Math.round(results.filter(r => r.estado === 'deficiente').length / results.length * 100)}%)
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}

                        {/* Instructions */}
                        {!excelData && !analyzing && (
                            <div className="bg-white rounded-lg shadow-lg p-8">
                                <h2 className="text-2xl font-bold text-gray-800 mb-6">
                                    üìö Gu√≠a de Instalaci√≥n y Uso
                                </h2>
                                <div className="space-y-6 text-gray-700">
                                    <div className="bg-blue-50 border-l-4 border-blue-500 p-4">
                                        <h3 className="font-bold text-lg mb-2">üîß Paso 1: Instalar Ollama (IA Local Gratuita)</h3>
                                        <ol className="list-decimal list-inside space-y-2 ml-4">
                                            <li>Descarga Ollama desde: <code className="bg-gray-100 px-2 py-1 rounded">https://ollama.com</code></li>
                                            <li>Instala el programa</li>
                                            <li>Abre una terminal y ejecuta: <code className="bg-gray-800 text-white px-2 py-1 rounded">ollama pull llama3.1:8b</code></li>
                                            <li>Inicia el servicio: <code className="bg-gray-800 text-white px-2 py-1 rounded">ollama serve</code></li>
                                        </ol>
                                    </div>

                                    <div className="bg-green-50 border-l-4 border-green-500 p-4">
                                        <h3 className="font-bold text-lg mb-2">üìÑ Paso 2: Preparar el Excel</h3>
                                        <p className="mb-2">Crea el archivo <code className="bg-gray-100 px-2 py-1 rounded">plan_gobierno_2025_2029.xlsx</code> con estas columnas:</p>
                                        <ul className="list-disc list-inside ml-4 space-y-1">
                                            <li><strong>Eje:</strong> El eje tem√°tico (ej: Seguridad Ciudadana)</li>
                                            <li><strong>Indicador:</strong> El indicador espec√≠fico a medir</li>
                                            <li><strong>Meta:</strong> La meta a alcanzar con a√±o</li>
                                        </ul>
                                        <p className="mt-2 text-sm">Guarda el archivo en: <code className="bg-gray-100 px-2 py-1 rounded">data/plan_gobierno_2025_2029.xlsx</code></p>
                                    </div>

                                    <div className="bg-purple-50 border-l-4 border-purple-500 p-4">
                                        <h3 className="font-bold text-lg mb-2">üêç Paso 3: Instalar Python y Dependencias</h3>
                                        <ol className="list-decimal list-inside space-y-2 ml-4">
                                            <li>Instala Python 3.10+ desde: <code className="bg-gray-100 px-2 py-1 rounded">python.org</code></li>
                                            <li>Abre terminal en la carpeta backend/</li>
                                            <li>Ejecuta: <code className="bg-gray-800 text-white px-2 py-1 rounded">pip install -r requirements.txt</code></li>
                                        </ol>
                                    </div>

                                    <div className="bg-orange-50 border-l-4 border-orange-500 p-4">
                                        <h3 className="font-bold text-lg mb-2">üöÄ Paso 4: Iniciar el Sistema</h3>
                                        <ol className="list-decimal list-inside space-y-2 ml-4">
                                            <li>En una terminal: <code className="bg-gray-800 text-white px-2 py-1 rounded">ollama serve</code></li>
                                            <li>En otra terminal en backend/: <code className="bg-gray-800 text-white px-2 py-1 rounded">python app.py</code></li>
                                            <li>Abre este archivo HTML en tu navegador</li>
                                            <li>Haz clic en "Cargar Plan de Gobierno" y luego en "Analizar Indicadores"</li>
                                        </ol>
                                    </div>

                                    <div className="bg-yellow-50 border-l-4 border-yellow-500 p-4">
                                        <h3 className="font-bold text-lg mb-2">üí° Caracter√≠sticas del Sistema</h3>
                                        <ul className="list-disc list-inside space-y-1 ml-4">
                                            <li>‚úÖ Lee autom√°ticamente los indicadores del Excel</li>
                                            <li>‚úÖ Busca datos actualizados en fuentes oficiales (INEC, ministerios, etc.)</li>
                                            <li>‚úÖ Usa IA (Llama) para analizar y comparar con las metas</li>
                                            <li>‚úÖ Clasifica cada indicador como eficiente, moderado o deficiente</li>
                                            <li>‚úÖ 100% gratuito y funciona localmente</li>
                                        </ul>
                                    </div>

                                    <div className="bg-red-50 border-l-4 border-red-500 p-4">
                                        <h3 className="font-bold text-lg mb-2">‚ö†Ô∏è Soluci√≥n de Problemas</h3>
                                        <ul className="list-disc list-inside space-y-1 ml-4">
                                            <li><strong>Backend no conecta:</strong> Verifica que app.py est√© corriendo en http://localhost:5050</li>
                                            <li><strong>Ollama error:</strong> Aseg√∫rate de ejecutar "ollama serve" primero</li>
                                            <li><strong>Excel no encontrado:</strong> Verifica la ruta data/plan_gobierno_2025_2029.xlsx</li>
                                            <li><strong>CORS error:</strong> Aseg√∫rate de abrir el HTML directamente, no desde file://</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Renderizar la aplicaci√≥n
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PlanGobiernoMonitor />);
    </script>
</body>
</html>